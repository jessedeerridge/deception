<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>テンプレ</title>
<style>
  html, body{height:100%; overflow:hidden;}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:#fff;color:#111;}

  header{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid #eee; position:sticky; top:0; z-index:400; background:#fff;}
  h1{margin:0;font-size:18px;}
  .small{font-size:12px;opacity:.75;}
  .join-box{display:flex;gap:6px;flex-wrap:wrap;align-items:center;padding:12px; position:relative; z-index:2;}
  .join-box input{padding:8px;border:1px solid #ddd;border-radius:6px;font-size:16px;}
  .btn{padding:6px 10px;border:1px solid #ddd;border-radius:6px;background:#f8f8f8;cursor:pointer;}
  .btn.primary{background:#111;color:#fff;border-color:#111;}
  .btn.ghost{background:transparent;}
  .hidden{display:none;}
  #lobby{padding:12px 12px 24px;border-top:1px solid #eee; position:relative; z-index:2;}
  .copy-btn.copied, .btn.ghost.copied{background:#16a34a;color:#fff;border-color:#16a34a;}

  main{
    position:relative;
    height:calc(100vh - 60px);
    overflow:auto;
    overflow-x:hidden; /* ★ 横スクロール防止 */
    -webkit-overflow-scrolling:touch;
    background-size:cover;
    background-position:center;
    background-repeat:no-repeat;
  }
  main.prejoin{ background-image:url('maemain.jpg'); }
  main.joined{ background-image:url('decemain.jpg'); }

  /* =========================
     ★ 右上：四角いビュー切替ボタン（header外）
     ========================= */
  .view-toggle-btn{
    position:fixed;
    top:72px;          /* headerの下にくる */
    right:14px;
    width:44px;
    height:44px;
    border-radius:10px;
    border:1px solid rgba(0,0,0,.12);
    background:rgba(255,255,255,.92);
    box-shadow:0 10px 24px rgba(0,0,0,.18);
    z-index:410;
    cursor:pointer;
    display:grid;
    place-items:center;
    user-select:none;
    -webkit-tap-highlight-color:transparent;
  }
  .view-toggle-btn:hover{ background:#fff; }
  .view-toggle-btn:active{ transform:translateY(1px); }
  .view-toggle-btn .icon{
    width:22px;height:22px;
    position:relative;
  }
  /* “ZOOM/WORD っぽい”＝9ドットのグリッド模様 */
  .view-toggle-btn .icon::before{
    content:"";
    position:absolute; inset:0;
    background:
      radial-gradient(circle, rgba(0,0,0,.78) 2px, transparent 3px) 0 0/11px 11px;
    opacity:.9;
    border-radius:6px;
  }
  /* 2列モード時にちょい強調 */
  body.two-col .view-toggle-btn{
    border-color:rgba(0,0,0,.28);
    box-shadow:0 12px 28px rgba(0,0,0,.22);
  }

  /* 着席ポップ */
  .seat-pop{
    position:fixed;left:50%;bottom:10px;transform:translateX(-50%);
    background:orange;border:1px solid #eee;border-radius:12px;
    box-shadow:0 12px 28px rgba(0,0,0,.12);
    padding:10px;z-index:220;display:flex;flex-direction:column;gap:10px;min-width:280px;
  }
  .seat-pop.hidden{display:none;}
  .seat-pop .row{display:flex;gap:8px;align-items:center;}
  .seat-pop label{width:84px;font-size:13px;}
  .seat-pop .tabs{display:flex;gap:6px;flex-wrap:wrap;}
  .tab{padding:6px 10px;border:1px solid #ddd;border-radius:999px;cursor:pointer;user-select:none;position:relative;}
  .tab.disabled{opacity:.45; pointer-events:none;}
  .tab.disabled::after{content:'✕';position:absolute;inset:0;display:grid;place-items:center;font-size:18px;font-weight:700;color:#b91c1c;pointer-events:none;}
  .tab.active{background:#111;color:#fff;border-color:#111;}

  /* 参加者：ホスト人数選択中ポップ */
  .host-selecting-pop{
    position:fixed;left:50%;bottom:10px;transform:translateX(-50%);
    background:rgba(20,20,20,.92);color:#fff;
    padding:12px 16px;border-radius:14px;
    box-shadow:0 18px 40px rgba(0,0,0,.35);
    z-index:225;font-weight:800;white-space:nowrap;
    pointer-events:none;
  }
  .host-selecting-pop.hidden{display:none;}

  /* 追い出し確認ダイアログ（そのまま残す） */
  .dialog-backdrop{
    position:fixed;inset:0;background:rgba(0,0,0,.35);
    display:flex;align-items:center;justify-content:center;z-index:300;
  }
  .dialog-backdrop.hidden{display:none;}
  .dialog-box{
    background:#fff;border-radius:12px;padding:16px 18px;
    box-shadow:0 18px 40px rgba(0,0,0,.35);
    max-width:320px;width:calc(100% - 40px);
  }
  .dialog-box p{margin:0 0 12px;font-size:14px;line-height:1.6;}
  .dialog-buttons{display:flex;justify-content:flex-end;gap:8px;}

  /* ホスト用 設定ボタン */
  .host-settings-btn{
    position:fixed;right:16px;bottom:16px;width:44px;height:44px;border-radius:50%;
    border:1px solid #ddd;background:#fff;box-shadow:0 8px 20px rgba(0,0,0,.18);
    display:none;align-items:center;justify-content:center;font-size:22px;cursor:pointer;z-index:230;
  }
  .host-settings-btn.visible{display:flex;}

  /* 設定ポップ */
  .start-pop{
    position:fixed;right:16px;bottom:72px;background:#fff;border:1px solid #ddd;border-radius:12px;
    box-shadow:0 12px 28px rgba(0,0,0,.16);padding:10px 12px;z-index:240;min-width:260px;
    display:flex;flex-direction:column;gap:8px;
  }
  .start-pop.hidden{display:none;}
  .start-pop-header{display:flex;justify-content:space-between;align-items:center;gap:8px;}
  .start-pop-title{font-size:14px;font-weight:600;}
  .start-pop-main{font-size:13px;line-height:1.5;}
  .start-pop-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:4px;flex-wrap:wrap;}

  /* ロビー見出しなど消す（必要なら残す） */
  #roomInfoLobby, #lobby h2, #lobby p {display:none;}
  #lobby.entered{
    display:flex;
    flex-direction:column;
    gap:10px;
  }

  /* =========================
     ★ 新UI：プレイヤー縦並び
     ========================= */
  .players-column{
    width:min(980px, calc(100% - 0px));
    margin:0 auto;
    display:flex;
    flex-direction:column;
    gap:10px;

    /* ★ 縮小スケール（2列時に下げる） */
    --uiScale: 1;
  }
  body.two-col .players-column{
    /* 2列時：同じ比率で縮小 */
    --uiScale: .82;
  }

  /* 2列モード：テーブルを2列グリッドに */
  body.two-col .players-column{
    display:grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap:10px;
    width: min(980px, calc(100% - 16px));
  }

  .player-block{
    background: rgba(25,25,25,.90);   /* 濃いグレー透明 */
    border: 1px solid rgba(255,255,255,.12);
    border-radius: calc(14px * var(--uiScale));
    box-shadow:0 10px 24px rgba(0,0,0,.20);
    padding: calc(5px * var(--uiScale));
    position:relative; /* ★ 右上ネームタグ用 */
    min-width:0;
  }

  /* ★ 2列モード時：正体カードは非表示 */
  body.two-col .role-wrap{ display:none; }

  /* ★ 2列モード時：テーブル右上内にネームタグ */
  .player-badge{
    position:absolute;
    top: calc(6px * var(--uiScale));
    right: calc(6px * var(--uiScale));
    padding: calc(3px * var(--uiScale)) calc(7px * var(--uiScale));
    border-radius: 999px;
    font-weight: 900;
    font-size: calc(11px * var(--uiScale));
    line-height: 1;
    letter-spacing:.02em;
    background: rgba(255,255,255,.92);
    color:#111;
    border:1px solid rgba(255,255,255,.25);
    box-shadow:0 6px 14px rgba(0,0,0,.22);
    display:none; /* 通常は出さない */
    max-width: 70%;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  body.two-col .player-badge{ display:block; }
  body.two-col .player-badge.me{ background:#111; color:#fff; border-color:#111; }

  /* 配札エリア：左に正体カード、右に2段（凶器/証拠品） */
  .deal-area{
    display:flex;
    gap: calc(10px * var(--uiScale));
    align-items:center; /* 上下中央に寄せる */
    min-width:0;
  }
  body.two-col .deal-area{
    align-items:flex-start;
    gap: calc(8px * var(--uiScale));
  }

  /* ★ ネームタグ：正体カードのすぐ上（フォント10） */
  .role-wrap{
    display:flex;
    flex-direction:column;
    gap:2px;
    flex:0 0 auto;
    align-items:flex-start;
  }
  .role-name-tag{
    font-size: calc(10px * var(--uiScale));
    font-weight:900;
    line-height:1.1;
    letter-spacing:.02em;
    padding: calc(2px * var(--uiScale)) calc(6px * var(--uiScale));
    border-radius:999px;
    background:#f3f4f6;
    border:1px solid #e5e7eb;
    color:#111;
  }
  .role-name-tag.me{
    background:#111;
    color:#fff;
    border-color:#111;
  }

  /* 正体カード（60x90） */
  .role-slot{
    width: calc(60px * var(--uiScale));
    height: calc(90px * var(--uiScale));
    border-radius: calc(10px * var(--uiScale));
    border: calc(2px * var(--uiScale)) solid #111;
    background:#fff;
    box-shadow:0 6px 16px rgba(0,0,0,.15);
    position:relative;
    overflow:hidden;
  }
  .role-slot.back{
    background:linear-gradient(135deg,#111,#333);
    border-color:#111;
  }
  .role-slot img{
    position:absolute; inset:0;
    width:100%;
    height:100%;
    object-fit:cover;
    display:block;
    background:#fff;
  }
  /* ★ 正体カードのカード名：右下（「正体」タグは不要） */
  .role-cardname{
    position:absolute;
    right: calc(4px * var(--uiScale));
    bottom: calc(4px * var(--uiScale));
    padding: calc(3px * var(--uiScale)) calc(5px * var(--uiScale));
    border-radius: calc(6px * var(--uiScale));
    background:rgba(0,0,0,.85);
    color:#fff;
    font-weight:900;
    font-size: calc(10px * var(--uiScale));
    line-height:1;
    max-width:calc(100% - 8px);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    box-shadow:0 4px 10px rgba(0,0,0,.25);
  }

  .two-rows{
    display:flex;
    flex-direction:column;
    gap: calc(8px * var(--uiScale));
    flex:1 1 auto;
    min-width:0;
  }
  .row4{
    display:flex;
    gap: calc(8px * var(--uiScale));
    flex-wrap:nowrap;
    overflow:auto;
    padding-bottom:2px;
    min-width:0;
  }
  /* ★ 2列モード時：横スクロールしない（カードを縮小＆折り返し） */
  body.two-col .row4{
    overflow:hidden;
    flex-wrap:wrap;
    gap: calc(6px * var(--uiScale));
    padding-top: calc(12px * var(--uiScale)); /* 右上ネームタグと被りにくく */
  }

  /* =========================
     ★ カード（60x90）
     凶器：#3b575b
     証拠品：#925f48
     ========================= */
  .card{
    width: calc(60px * var(--uiScale));
    height: calc(90px * var(--uiScale));
    border-radius: calc(10px * var(--uiScale));
    background:#fff;
    box-shadow:0 6px 16px rgba(0,0,0,.15);
    position:relative;
    overflow:hidden;
    flex:0 0 auto;
  }
  .card.weapon{ border: calc(3px * var(--uiScale)) solid #3b575b; }
  .card.evidence{ border: calc(3px * var(--uiScale)) solid #925f48; }

  .card img{
    position:absolute; inset:0;
    width:100%;
    height:100%;
    object-fit:cover;
    display:block;
    background:#fff;
  }

  /* ★ カード左上の名前タグ：手動改行 + 自動フィット */
  .name-tag{
    position:absolute;
    left: calc(4px * var(--uiScale));
    top: calc(5px * var(--uiScale));
    padding: calc(6px * var(--uiScale)) calc(3px * var(--uiScale));
    border-radius: calc(7px * var(--uiScale));
    font-weight:900;
    font-size: calc(12px * var(--uiScale)); /* ←基準（JSで下げる） */
    line-height:1.15;
    color:#fff;

    box-sizing:border-box;
    max-width:calc(100% - 8px); /* ←必ず枠内 */
    white-space:normal;
    overflow:hidden;            /* ←タグ領域からはみ出さない */
    max-height:5.3em;           /* ←最大2行（手動改行は2行想定） */
    box-shadow:0 4px 10px rgba(0,0,0,.25);
  }
  .name-tag .line{display:block; white-space:nowrap;} /* ←各行は折り返さない（手動改行固定） */

  .weapon .name-tag{ background:#3b575b; }
  .evidence .name-tag{ background:#925f48; }
</style>
</head>

<body>
<header>
  <h1>テンプレ</h1>
  <div style="display:flex;align-items:center;gap:6px;">
    <div class="small" id="roomInfo"></div>
    <button class="btn ghost" id="copyLinkBtn">COPY</button>
  </div>
</header>

<!-- ★ header外：右上の四角ボタン -->
<button id="viewToggleBtn" class="view-toggle-btn" title="表示切替（1列 / 2列）" aria-label="表示切替（1列 / 2列）">
  <div class="icon" aria-hidden="true"></div>
</button>

<main id="main" class="prejoin">
  <div class="join-box" id="joinBox">
    <input id="userName" placeholder="名前（4文字以内）" maxlength="4" />
    <input id="roomCode" placeholder="ルームコード（未入力で自動生成）" maxlength="12" />
    <button class="btn primary" id="btnJoin">入室</button>
  </div>

  <div id="lobby" class="hidden">
    <h2>ロビー</h2>
    <div id="roomInfoLobby" style="margin-bottom:8px;"></div>
    <p>ここにテーブルや情報が表示されます。</p>

    <div class="players-column" id="playersColumn"></div>
  </div>
</main>

<div id="hostSelectingPop" class="host-selecting-pop hidden">ホストが人数を選択中</div>

<div id="seatPop" class="seat-pop hidden">
  <div class="row"><label>席を選択</label><div id="seatTabs" class="tabs"></div></div>
  <div class="row" style="justify-content:flex-end">
    <button class="btn small ghost" id="btnSeatCancel">観戦</button>
  </div>
</div>

<div id="kickDialog" class="dialog-backdrop hidden">
  <div class="dialog-box" id="kickDialogBox">
    <p id="kickMessage">既存のプレイヤーを追い出して、着席しますか？</p>
    <div class="dialog-buttons">
      <button class="btn ghost" id="btnKickNo">いいえ</button>
      <button class="btn primary" id="btnKickYes">はい</button>
    </div>
  </div>
</div>

<button id="hostSettingsBtn" class="host-settings-btn" title="設定">⚙</button>

<div id="startPop" class="start-pop hidden">
  <div class="start-pop-header">
    <div class="start-pop-title">ホスト設定</div>
    <button id="btnStartPopClose" class="btn ghost" style="padding:2px 6px;font-size:12px;">×</button>
  </div>
  <div class="start-pop-main">
    「スタート」で全プレイヤーに配布。<br>
    「リセット」で人数選択へ戻します。
  </div>
  <div class="start-pop-actions">
    <button id="btnResetRoom" class="btn ghost">リセット</button>
    <button id="btnGameStart" class="btn primary">スタート</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getDatabase, ref, set, get, update, onValue, remove
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyAMeKfMoHt9qOQ2VuUBpkrKuei7yGBbEi8",
  authDomain: "cheesetheft-fd52f.firebaseapp.com",
  databaseURL: "https://cheesetheft-fd52f-default-rtdb.firebaseio.com",
  projectId: "cheesetheft-fd52f",
  storageBucket: "cheesetheft-fd52f.firebasestorage.app",
  messagingSenderId: "298688959395",
  appId: "1:298688959395:web:6ac2c3eb214201f2020016",
  measurementId: "G-HPDFTCLR8H"
};
const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

/* userId: タブ単位固定 */
const savedUserId = sessionStorage.getItem('bbUserId') || crypto.randomUUID();
sessionStorage.setItem('bbUserId', savedUserId);

/* 状態 */
const state = {
  userId: savedUserId,
  userName: null,
  roomCode: null,
  seatedTable: null,
  isHost: false,
  room: {},
  deal: {}, // rooms/.../deal を保持
};

const WEAPONS = [
"液体薬品","鉢植え","仕事","ヘッドフォン","密室","バリアロープ","こて","石膏像","レンガ","スカーフ","汚れた手","ビニール袋","なた","ダガー","踏みつけ","ワイン","マッチ","狂犬","注射","針金","ノド切り","ムチ","素手","農薬","違法N\\ドラッグ","線路","レーザーN\\シャーク","竹やり","血液N\\サンプル","スカーフ","過剰摂取","四肢切断","毒サソリ","ウイルス","放火","噛みつき","ガムテープ","釣り針","灯油","トロフィー","ハンマー","折りたたみN\\イス","機械","カミソリ","タオル","枕","水銀","毒グモ","爆薬","蜜蜂","錠剤","斧","溺死","電流","鮫","ベルト","生き埋め","ハサミ","放射線","粉末薬","鎖","ゲーム機","松葉杖","チェーンソー","セール看板","ウェブカメラ","セメント","手術","サックス","失血","スケート靴","石","煙","燭台","消火器","バット","電線","パンチ","毒ヘビ","餓死","バイク","毒針","ライター","拳銃","ヒ素","アメーバ","アルコール","ロープ","ダンベル","レーザー銃","押し出し","狙撃","レンチ","伝染病","電気警棒","ミキサー","肉切り包丁","汚水","キック","ナイフとN\\フォーク","化学薬品","火薬","スポーク","毒ガス","硫酸","カッター","鉄パイプ","ドリル"
];

const EVIDENCES = [
"ヘルメット","IDカード","注射器","制服","ノート","ハイヒール","トランプ","ピーナッツ","ジュース","ファン","動画サイト","調味料","インク","蒸しパン","懐中電灯","サングラス","リモコン","社員証","麻雀牌","光N\\ファイバー","インターネットN\\ケーブル","エアコン","サイン","ネックレス","文書","懐中時計","携帯電話","カップ","ダイアモンド","アンティーク","メニュー","地図","血","羽根ペン","野菜","針と糸","ベル","スイッチ","密書","借用証書","ランプ","腕時計","フルート","ゴム印","釘","綿","しるし","雑誌","ストッキング","顔パック","ゴキブリ","ケーキ","コンピューター","蚊取りN\\線香","チップ","トランク","数字","レインN\\コート","ファックス","パン","ジャケット","電球","ビデオカメラ","油絵","イヤリング","粉末","錠前","アイロン","迷路","蟻","ヘアピン","メモ","食材","模型","帽子","ぬいぐるみ","骨","鍵","ブリーフ","タトゥー","名刺","爪","手錠","バッジ","紳士帽","贈り物","手袋","犬の毛","変換プラグ","新聞","三脚","ヘッドフォン","包帯","写真","招待状","香水","茶葉","のり","お面","弾丸","口紅","招待状","ティッシュ","グラフィティ","人形","トランプ","スナック菓子","蚊","海老","切手","宝石","卵","紙幣","砂","ハンガー","植物","封筒","調味料","氷","葉っぱ","日記","ボタン","レンズ","革の靴","革の鞄","マウス","コイン","弁当箱","赤ワイン","油のシミ","チラシ","カーテン","事務用品","スポンジ","ボールペン","USBメモリ","鏡","タバコの灰","インスタント麺","輸血パック","靴下","砂時計","ビーチN\\サンダル","謝罪メモ","ガラスのN\\破片","歯車","試験用紙","昆虫","ダンボール箱","積み木","入れ歯","ラブレター","宅急便","ゲーミングN\\バッグ","漢方薬","髪の毛","宝くじ"
];

/* DOM */
const mainEl = document.getElementById('main');
const joinBox = document.getElementById('joinBox');
const inputName = document.getElementById('userName');
const inputCode = document.getElementById('roomCode');
const btnJoin = document.getElementById('btnJoin');
const lobby = document.getElementById('lobby');
const roomInfo = document.getElementById('roomInfo');
const roomInfoLobby = document.getElementById('roomInfoLobby');
const copyLinkBtn = document.getElementById('copyLinkBtn');

const hostSelectingPop = document.getElementById('hostSelectingPop');

const seatPop = document.getElementById('seatPop');
const seatTabs = document.getElementById('seatTabs');
const btnSeatCancel = document.getElementById('btnSeatCancel');
const seatLabel = seatPop.querySelector('label');

const playersColumn = document.getElementById('playersColumn');

const kickDialog = document.getElementById('kickDialog');
const kickMessage = document.getElementById('kickMessage');
const btnKickYes = document.getElementById('btnKickYes');
const btnKickNo = document.getElementById('btnKickNo');

const hostSettingsBtn = document.getElementById('hostSettingsBtn');
const startPop = document.getElementById('startPop');
const btnStartPopClose = document.getElementById('btnStartPopClose');
const btnGameStart = document.getElementById('btnGameStart');
const btnResetRoom = document.getElementById('btnResetRoom');

/* ★ 表示切替ボタン */
const viewToggleBtn = document.getElementById('viewToggleBtn');

/* 追い出し（必要なら残す） */
let pendingSeatIndexToSteal = null;
let pendingSeatPlayerIdToSteal = null;
let isRenderingSeatTabs = false;
let latestPlayers = [];

/* =========================
   ★ 手動改行 & 自動フィット
   ルール：
   - 名前に "N\" を入れると、その位置で改行（2行表示）
     例： "レーザーN\シャーク" / "インターネットN\ケーブル"
   - それぞれの行がタグ枠内に入るサイズまでフォントを自動で下げる
   ========================= */
const _fitCanvas = document.createElement('canvas');
const _fitCtx = _fitCanvas.getContext('2d');

function splitManualLines(name){
  if (name.includes('N\\')) return name.split('N\\');
  if (name.includes('\n')) return name.split('\n');
  return [name];
}

function setNameTagLines(tagEl, name){
  const lines = splitManualLines(name).slice(0, 2); // 2行まで
  tagEl.innerHTML = '';
  for (const line of lines){
    const s = document.createElement('span');
    s.className = 'line';
    s.textContent = line;
    tagEl.appendChild(s);
  }
  return lines;
}

function measureTextWidthPx(text, font){
  _fitCtx.font = font;
  return _fitCtx.measureText(text).width;
}

function fitNameTag(tagEl, lines){
  requestAnimationFrame(() => {
    const cs = getComputedStyle(tagEl);

    const padL = parseFloat(cs.paddingLeft) || 0;
    const padR = parseFloat(cs.paddingRight) || 0;
    const availW = Math.max(0, tagEl.clientWidth - padL - padR);

    const family = cs.fontFamily || 'system-ui';
    const weight = cs.fontWeight || '900';

    // ★ 2列モードでは縮小に合わせて上限も少し下げる
    const isTwoCol = document.body.classList.contains('two-col');
    const maxFont = isTwoCol ? 9 : 10;
    const minFont = isTwoCol ? 5 : 6;

    for (let size = maxFont; size >= minFont; size--){
      const font = `${weight} ${size}px ${family}`;
      let ok = true;
      for (const line of lines){
        const w = measureTextWidthPx(line, font);
        if (w > availW) { ok = false; break; }
      }
      if (ok){
        tagEl.style.fontSize = `${size}px`;
        return;
      }
    }
    tagEl.style.fontSize = `${minFont}px`;
  });
}
/* ========================= */

function generateRoomCode(length = 6){
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  let code = '';
  for(let i=0;i<length;i++) code += chars.charAt(Math.floor(Math.random()*chars.length));
  return code;
}

function refreshRoomLabels(){
  if (!state.roomCode || !state.userName) return;
  const label = state.isHost ? '（ホスト）' : '';
  const infoText = ` ${state.roomCode},  ${state.userName}${label}`;
  roomInfo.textContent = infoText;
  roomInfoLobby.textContent = infoText;
}

function updateHostUI(){
  refreshRoomLabels();
  if (state.isHost){
    hostSettingsBtn.classList.add('visible');
  } else {
    hostSettingsBtn.classList.remove('visible');
    startPop.classList.add('hidden');
  }
}

/* =========================
   ★ 表示モード：1列 / 2列
   ========================= */
function setTwoColMode(on){
  document.body.classList.toggle('two-col', !!on);
  localStorage.setItem('bbTwoCol', on ? '1' : '0');

  // 2列に切替後、タグの自動フィットをやり直す
  requestAnimationFrame(() => {
    document.querySelectorAll('.name-tag').forEach(tagEl => {
      const name = tagEl.getAttribute('data-name') || '';
      const lines = splitManualLines(name).slice(0,2);
      setNameTagLines(tagEl, name);
      fitNameTag(tagEl, lines);
    });
  });
}
(function initTwoCol(){
  const saved = localStorage.getItem('bbTwoCol') === '1';
  setTwoColMode(saved);
})();
viewToggleBtn.addEventListener('click', () => {
  const on = !document.body.classList.contains('two-col');
  setTwoColMode(on);
});
/* ========================= */

/* subscribe */
function subscribeRoom(){
  const roomRef = ref(db, `rooms/${state.roomCode}`);
  onValue(roomRef, snap => {
    state.room = snap.val() || {};
    const waiting = (!state.isHost && !state.room.maxPlayers);
    hostSelectingPop.classList.toggle('hidden', !waiting);
    syncSeatUI();
  });
}
function subscribeHostState(){
  const hostRef = ref(db, `rooms/${state.roomCode}/hostId`);
  onValue(hostRef, snap => {
    const hostId = snap.val();
    state.isHost = (hostId === state.userId);
    updateHostUI();
    syncSeatUI();
  });
}
function subscribePlayers(){
  const tablesRef = ref(db, `rooms/${state.roomCode}/tables`);
  onValue(tablesRef, async snap => {
    const data = snap.val() || {};
    const players = Object.entries(data)
      .map(([seatIndex, t]) => (t && t.playerId ? {
        id: t.playerId,
        name: t.playerName || '名無し',
        seatIndex: Number(seatIndex)
      } : null))
      .filter(Boolean)
      .sort((a,b) => a.seatIndex - b.seatIndex);

    latestPlayers = players;

    const mySeat = players.find(p => p.id === state.userId);
    if (mySeat && state.seatedTable === null) {
      state.seatedTable = mySeat.seatIndex;
      seatPop.classList.add('hidden');
    }

    const meStillSeated = players.some(p => p.id === state.userId);
    if (!meStillSeated && state.seatedTable !== null) state.seatedTable = null;

    await syncSeatUI();
    renderPlayersVertical(players);
  });
}
function subscribeDeal(){
  const dealRef = ref(db, `rooms/${state.roomCode}/deal`);
  onValue(dealRef, snap => {
    state.deal = snap.val() || {};
    renderPlayersVertical(latestPlayers);
  });
}

async function syncSeatUI(){
  if (!state.roomCode) return;

  const maxPlayers = state.room.maxPlayers || null;

  if (!state.isHost && !maxPlayers){
    seatPop.classList.add('hidden');
    return;
  }
  if (state.seatedTable !== null){
    seatPop.classList.add('hidden');
    return;
  }
  await renderSeatTabs();
  seatPop.classList.remove('hidden');
}

async function renderSeatTabs(){
  if (!state.roomCode) return;
  if (isRenderingSeatTabs) return;
  isRenderingSeatTabs = true;

  try {
    seatTabs.innerHTML = '';

    const roomRef = ref(db, `rooms/${state.roomCode}`);
    const roomSnap = await get(roomRef);
    const roomData = roomSnap.val() || {};
    const maxPlayers = roomData.maxPlayers || null;

    if(state.isHost && !maxPlayers){
      seatLabel.textContent = '人数を選択';
      for(let i=2; i<=8; i++){
        const tab = document.createElement('div');
        tab.className = 'tab';
        tab.textContent = i;

        tab.onclick = async () => {
          await update(roomRef, { maxPlayers: i });
          const tRef = ref(db, `rooms/${state.roomCode}/tables/1`);
          await set(tRef, { playerId: state.userId, playerName: state.userName });

          state.seatedTable = 1;
          seatPop.classList.add('hidden');
        };
        seatTabs.appendChild(tab);
      }
      return;
    }

    seatLabel.textContent = '席を選択';

    const effectiveMax = maxPlayers || 8;
    const tablesSnap = await get(ref(db, `rooms/${state.roomCode}/tables`));
    const tables = tablesSnap.val() || {};

    for(let i=1; i<=effectiveMax; i++){
      const tab = document.createElement('div');
      tab.className = 'tab';
      tab.textContent = i;

      const t = tables[i];
      if(t && t.playerId) tab.classList.add('disabled');

      tab.onclick = async () => {
        if(tab.classList.contains('disabled')) return;
        const tRef = ref(db, `rooms/${state.roomCode}/tables/${i}`);
        await set(tRef, { playerId: state.userId, playerName: state.userName || '名無し' });
        state.seatedTable = i;
        seatPop.classList.add('hidden');
      };
      seatTabs.appendChild(tab);
    }
  } finally {
    isRenderingSeatTabs = false;
  }
}

btnSeatCancel.onclick = () => {
  seatPop.classList.add('hidden');
  state.seatedTable = null;
};

/* util */
function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

/* render */
function makeCardEl(kind, name){
  const d = document.createElement('div');
  d.className = `card ${kind}`;

  const img = document.createElement('img');
  const fileName = name.replaceAll('N\\', '').replaceAll('\n', '');
  img.src = `${fileName}.jpg`;
  img.alt = name;
  img.loading = 'eager';

  const tag = document.createElement('div');
  tag.className = 'name-tag';
  tag.setAttribute('data-name', name); // ★ 2列切替で再フィットするため保持

  const lines = setNameTagLines(tag, name);

  d.appendChild(img);
  d.appendChild(tag);

  fitNameTag(tag, lines);

  return d;
}

/* ★ 正体カード */
function makeRoleWrap(playerName, isMe, showFace, roleName){
  const wrap = document.createElement('div');
  wrap.className = 'role-wrap';

  const nameTag = document.createElement('div');
  nameTag.className = 'role-name-tag' + (isMe ? ' me' : '');
  nameTag.textContent = playerName || '名無し';
  wrap.appendChild(nameTag);

  const role = document.createElement('div');
  role.className = 'role-slot' + (showFace ? '' : ' back');

  if (showFace && roleName){
    const img = document.createElement('img');
    img.src = `${roleName}.jpg`;
    img.alt = roleName;
    img.loading = 'eager';
    role.appendChild(img);

    const cn = document.createElement('div');
    cn.className = 'role-cardname';
    cn.textContent = roleName;
    role.appendChild(cn);
  }

  wrap.appendChild(role);
  return wrap;
}

function renderPlayersVertical(players){
  playersColumn.innerHTML = '';
  if (!players || !players.length) return;

  players.forEach(p => {
    const block = document.createElement('div');
    block.className = 'player-block';

    // ★ 2列モード用：右上ネームタグ（通常はCSSで非表示）
    const badge = document.createElement('div');
    badge.className = 'player-badge' + (p.id === state.userId ? ' me' : '');
    badge.textContent = p.name || '名無し';
    block.appendChild(badge);

    const dealArea = document.createElement('div');
    dealArea.className = 'deal-area';

    const deal = (state.deal && state.deal[p.id]) ? state.deal[p.id] : null;

    /* 正体：自分だけ表（他人は裏） */
    const showRoleFace = (p.id === state.userId);
    const roleName = deal ? (deal.role || '') : '';
    dealArea.appendChild(makeRoleWrap(p.name, p.id === state.userId, showRoleFace, roleName));

    const twoRows = document.createElement('div');
    twoRows.className = 'two-rows';

    const rowW = document.createElement('div');
    rowW.className = 'row4';
    const rowE = document.createElement('div');
    rowE.className = 'row4';

    if (deal && Array.isArray(deal.weapons)){
      deal.weapons.slice(0,4).forEach(name => rowW.appendChild(makeCardEl('weapon', name)));
    }
    if (deal && Array.isArray(deal.evidences)){
      deal.evidences.slice(0,4).forEach(name => rowE.appendChild(makeCardEl('evidence', name)));
    }

    twoRows.appendChild(rowW);
    twoRows.appendChild(rowE);

    dealArea.appendChild(twoRows);
    block.appendChild(dealArea);

    playersColumn.appendChild(block);
  });
}

/* join */
const urlParams = new URLSearchParams(window.location.search);
const roomFromUrl = urlParams.get('room');
if(roomFromUrl) inputCode.value = roomFromUrl;

btnJoin.addEventListener('click', async () => {
  state.userName = inputName.value || '名無し';
  state.roomCode = inputCode.value.trim() || generateRoomCode();

  await set(ref(db, `rooms/${state.roomCode}/users/${state.userId}`), {
    name: state.userName,
    joinedAt: Date.now()
  });

  const roomRef = ref(db, `rooms/${state.roomCode}`);
  const roomSnap = await get(roomRef);
  const roomData = roomSnap.val();

  if(!roomData || !roomData.hostId){
    await update(roomRef, { hostId: state.userId });
    state.isHost = true;
  } else {
    state.isHost = (roomData.hostId === state.userId);
  }

  updateHostUI();

  mainEl.classList.remove('prejoin');
  mainEl.classList.add('joined');

  joinBox.classList.add('hidden');
  lobby.classList.remove('hidden');
  lobby.classList.add('entered');

  subscribeRoom();
  subscribeHostState();
  subscribePlayers();
  subscribeDeal();

  syncSeatUI();
});

/* copy */
copyLinkBtn.addEventListener('click', async () => {
  const url = `${location.origin}${location.pathname}?room=${state.roomCode}`;
  try {
    await navigator.clipboard.writeText(url);
    copyLinkBtn.classList.add('copied');
    copyLinkBtn.textContent = 'COPIED';
    inputCode.value = state.roomCode;
    setTimeout(()=>{
      copyLinkBtn.classList.remove('copied');
      copyLinkBtn.textContent='COPY';
    },1500);
  } catch {
    prompt('コピーできません。手動でコピーしてください', url);
  }
});

/* kick dialog handlers（残す） */
kickDialog.addEventListener('click', (e) => {
  if (e.target === kickDialog) {
    kickDialog.classList.add('hidden');
    pendingSeatIndexToSteal = null;
    pendingSeatPlayerIdToSteal = null;
  }
});
btnKickNo.addEventListener('click', (e) => {
  e.stopPropagation();
  kickDialog.classList.add('hidden');
  pendingSeatIndexToSteal = null;
  pendingSeatPlayerIdToSteal = null;
});
btnKickYes.addEventListener('click', async (e) => {
  e.stopPropagation();
  if (pendingSeatIndexToSteal == null || !state.roomCode) {
    kickDialog.classList.add('hidden');
    return;
  }

  const seatIndex = pendingSeatIndexToSteal;
  const roomRef = ref(db, `rooms/${state.roomCode}`);
  const roomSnap = await get(roomRef);
  const roomData = roomSnap.val() || {};

  const tRef = ref(db, `rooms/${state.roomCode}/tables/${seatIndex}`);
  await set(tRef, { playerId: state.userId, playerName: state.userName || '名無し' });

  if (roomData.hostId && pendingSeatPlayerIdToSteal && roomData.hostId === pendingSeatPlayerIdToSteal) {
    await update(roomRef, { hostId: state.userId });
  }

  state.seatedTable = seatIndex;

  kickDialog.classList.add('hidden');
  pendingSeatIndexToSteal = null;
  pendingSeatPlayerIdToSteal = null;

  seatPop.classList.add('hidden');
});

/* host settings */
hostSettingsBtn.addEventListener('click', () => {
  if (!state.isHost) return;
  startPop.classList.toggle('hidden');
});
btnStartPopClose.addEventListener('click', () => {
  startPop.classList.add('hidden');
});

/* ★ 配布：スタートで各プレイヤーに */
async function dealToAllPlayers(){
  if (!state.roomCode) return;

  const tablesSnap = await get(ref(db, `rooms/${state.roomCode}/tables`));
  const tables = tablesSnap.val() || {};
  const players = Object.entries(tables)
    .map(([seatIndex, t]) => (t && t.playerId ? {
      id: t.playerId,
      name: t.playerName || '名無し',
      seatIndex: Number(seatIndex)
    } : null))
    .filter(Boolean)
    .sort((a,b) => a.seatIndex - b.seatIndex);

  const n = players.length;
  if (n <= 0) return;

  const uniqW = Array.from(new Set(WEAPONS));
  const uniqE = Array.from(new Set(EVIDENCES));

  const sw = shuffle(uniqW);
  const se = shuffle(uniqE);

  const roles = [];
  roles.push("殺人犯");
  roles.push("法医学者");
  while (roles.length < n) roles.push("捜査官");
  const sRoles = shuffle(roles);

  const deal = {};
  let wIdx = 0;
  let eIdx = 0;

  for (let i=0;i<n;i++){
    const pid = players[i].id;

    const weapons = [];
    const evidences = [];

    for (let k=0;k<4;k++){
      if (sw.length) weapons.push(sw[wIdx % sw.length]);
      wIdx++;
    }
    for (let k=0;k<4;k++){
      if (se.length) evidences.push(se[eIdx % se.length]);
      eIdx++;
    }

    deal[pid] = {
      role: sRoles[i],
      weapons,
      evidences,
      dealtAt: Date.now()
    };
  }

  await set(ref(db, `rooms/${state.roomCode}/deal`), deal);
}

btnGameStart.addEventListener('click', async () => {
  if (!state.isHost) return;
  await dealToAllPlayers();
  startPop.classList.add('hidden');
});

btnResetRoom.addEventListener('click', async () => {
  if (!state.isHost || !state.roomCode) return;
  const base = `rooms/${state.roomCode}`;
  await Promise.all([
    remove(ref(db, `${base}/maxPlayers`)),
    remove(ref(db, `${base}/tables`)),
    remove(ref(db, `${base}/deal`))
  ]);
  state.seatedTable = null;
  startPop.classList.add('hidden');
  await syncSeatUI();
});
</script>
</body>
</html>
